<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUV Training Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .navy-header { background-color: #1e293b; }
        #loader { position: fixed; inset: 0; background: #ffffff; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s; }
    </style>
</head>
<body>

    <div id="loader">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
        <p class="text-slate-600 font-semibold">Loading TUV Data...</p>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">TUV Training Dashboard</h1>
                <p class="text-slate-500">Search and verify certification status</p>
            </div>
            <div class="bg-white p-1 rounded-xl shadow-sm border flex">
                <button onclick="showPage(1)" id="btn1" class="px-6 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white transition-all">Dashboard</button>
                <button onclick="showPage(2)" id="btn2" class="px-6 py-2 rounded-lg text-sm font-bold text-slate-600 transition-all">View All Data</button>
            </div>
        </div>

        <div id="page1" class="space-y-6">
            <div class="relative group">
                <i class="fa fa-search absolute left-5 top-5 text-slate-400 text-lg transition-colors group-focus-within:text-blue-500"></i>
                <input type="text" id="search" onkeyup="doSearch()" placeholder="Type Employee Name or ID..." 
                    class="w-full p-5 pl-14 rounded-2xl border-0 card-shadow outline-none ring-2 ring-transparent focus:ring-blue-500 transition-all text-lg">
                <button onclick="resetSearch()" class="absolute right-5 top-5 text-slate-300 hover:text-red-500"><i class="fa fa-times-circle"></i></button>
                
                <div id="suggestions" class="absolute w-full mt-2 bg-white rounded-2xl shadow-2xl z-50 hidden max-h-64 overflow-y-auto border border-slate-100"></div>
            </div>

            <div id="dashGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 min-h-[400px]">
                <div class="col-span-full flex flex-col items-center justify-center py-20 bg-white/50 rounded-3xl border-2 border-dashed border-slate-300">
                    <i class="fa fa-id-card-clip text-6xl text-slate-200 mb-4"></i>
                    <p class="text-slate-400 font-medium">Search for an employee to display card details</p>
                </div>
            </div>
        </div>

        <div id="page2" class="hidden">
            <div class="bg-white rounded-2xl card-shadow overflow-hidden border border-slate-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm" id="tableContent"></table>
                </div>
            </div>
        </div>

        <footer class="mt-16 pt-8 border-t border-slate-200 text-center">
            <p class="text-slate-400 font-medium">Created by <span class="text-slate-900 font-bold underline">Mohammad Javed Shaikh</span></p>
        </footer>
    </div>

    <script>
        let mainData = [];
        // UPDATED TO .xlsx
        const EXCEL_FILE = "TUV Training Log.xlsx";

        async function loadData() {
            try {
                const response = await fetch(EXCEL_FILE);
                if (!response.ok) throw new Error("File Not Found");
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

                // Row 1 is merged title, Row 2 is headers, Row 3 is data
                mainData = json.slice(2); 
                renderFullTable(json.slice(1)); // Start table from headers

                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 400);
            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerHTML = `<p class="text-red-500 font-bold">Error: ${EXCEL_FILE} not found in root folder.</p>`;
            }
        }

        function doSearch() {
            const input = document.getElementById('search').value.toLowerCase();
            const sugg = document.getElementById('suggestions');
            if (input.length < 2) { sugg.classList.add('hidden'); return; }

            const filtered = mainData.filter(r => 
                String(r[1]).toLowerCase().includes(input) || 
                String(r[2]).toLowerCase().includes(input)
            ).slice(0, 8);

            if (filtered.length > 0) {
                sugg.innerHTML = filtered.map(r => `
                    <div onclick="updateDashboard('${r[1]}')" class="p-4 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center transition-colors">
                        <span class="font-bold text-slate-700">${r[2]}</span>
                        <span class="px-2 py-1 bg-slate-100 text-[10px] font-bold rounded text-slate-500 uppercase">ID: ${r[1]}</span>
                    </div>
                `).join('');
                sugg.classList.remove('hidden');
            } else {
                sugg.classList.add('hidden');
            }
        }

        function updateDashboard(id) {
            const row = mainData.find(x => String(x[1]) === String(id));
            document.getElementById('suggestions').classList.add('hidden');
            document.getElementById('search').value = row[2];

            // Calculation Logic
            const expDate = new Date(row[6]);
            const today = new Date();
            const diff = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            
            let status = { t: 'VALID', c: 'text-green-600', i: 'fa-check-circle', b: 'bg-green-100' };
            if (diff <= 0) status = { t: 'EXPIRED', c: 'text-red-600', i: 'fa-times-circle', b: 'bg-red-100' };
            else if (diff <= 30) status = { t: 'EXPIRING SOON', c: 'text-orange-600', i: 'fa-exclamation-triangle', b: 'bg-orange-100' };

            const cards = [
                { l: 'Position', v: row[3], i: 'fa-briefcase' },
                { l: 'Type', v: row[4], i: 'fa-layer-group' },
                { l: 'Issue Date', v: fDate(row[5]), i: 'fa-calendar-day' },
                { l: 'Expiry Date', v: fDate(row[6]), i: 'fa-calendar-xmark' },
                { l: 'Remaining Days', v: diff, i: 'fa-hourglass-half' },
                { l: 'Status', v: status.t, color: status.c, icon: status.i, bg: status.b },
                { l: 'Institute', v: row[7], i: 'fa-building-columns' },
                { l: 'Renewal Req.', v: fDate(row[8]), i: 'fa-clock-rotate-left' },
                { l: 'Certificate', v: row[9], i: 'fa-certificate' },
                { l: 'Emp Status', v: row[10], i: 'fa-user-gear' },
                { l: 'Remarks', v: row[11] || 'None', i: 'fa-comment-dots' },
                { l: 'Physical Copy', v: row[12], i: 'fa-file-signature' }
            ];

            document.getElementById('dashGrid').innerHTML = cards.map(c => `
                <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-50 flex items-center gap-4 transition-transform hover:scale-[1.02]">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl ${c.bg || 'bg-slate-50'} ${c.color || 'text-slate-400'}">
                        <i class="fa ${c.icon}"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${c.l}</p>
                        <p class="text-lg font-bold ${c.color || 'text-slate-800'}">${c.v || 'N/A'}</p>
                    </div>
                </div>
            `).join('');
        }

        function fDate(d) {
            if (!d) return 'N/A';
            const date = new Date(d);
            return isNaN(date) ? d : date.toLocaleDateString('en-GB');
        }

        function renderFullTable(data) {
            const table = document.getElementById('tableContent');
            table.innerHTML = data.map((r, i) => `
                <tr class="${i === 0 ? 'navy-header text-white font-bold' : 'border-b hover:bg-slate-50'}">
                    ${r.map(cell => `<td class="p-4 border-r border-slate-100">${cell}</td>`).join('')}
                </tr>
            `).join('');
        }

        function showPage(p) {
            document.getElementById('page1').classList.toggle('hidden', p !== 1);
            document.getElementById('page2').classList.toggle('hidden', p !== 2);
            document.getElementById('btn1').className = p === 1 ? 'px-6 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-md' : 'px-6 py-2 rounded-lg text-sm font-bold text-slate-600';
            document.getElementById('btn2').className = p === 2 ? 'px-6 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-md' : 'px-6 py-2 rounded-lg text-sm font-bold text-slate-600';
        }

        function resetSearch() {
            document.getElementById('search').value = "";
            document.getElementById('suggestions').classList.add('hidden');
            location.reload();
        }

        window.onload = loadData;
    </script>
</body>
</html>
